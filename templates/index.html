<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メモリー廃棄管理</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: #f5f5f5; color: #333; padding: 20px; max-width: 1280px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #2c3e50; }
        h2 { margin: 24px 0 12px; color: #34495e; font-size: 1.1em; }

        .flash { padding: 10px 16px; border-radius: 4px; margin-bottom: 12px; }
        .flash.success { background: #d4edda; color: #155724; }
        .flash.error { background: #f8d7da; color: #721c24; }
        .flash.info { background: #d1ecf1; color: #0c5460; }

        .add-form { background: #fff; padding: 16px; border-radius: 6px; margin-bottom: 20px; display: flex; gap: 8px; align-items: end; flex-wrap: wrap; }
        .add-form label { font-size: 0.85em; color: #666; }
        .add-form .field { display: flex; flex-direction: column; gap: 4px; }
        input, select, button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; }
        button { background: #3498db; color: #fff; border: none; cursor: pointer; white-space: nowrap; }
        button:hover { background: #2980b9; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        button.approve { background: #27ae60; }
        button.approve:hover { background: #219a52; }
        button.warn { background: #f39c12; }
        button.warn:hover { background: #d68910; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5c636a; }

        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 6px; overflow: hidden; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9em; }
        th { background: #2c3e50; color: #fff; }

        .status { padding: 3px 8px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        .status.pending { background: #ffeaa7; color: #6c5c00; }
        .status.approved { background: #a3e4a1; color: #1a5c18; }
        .status.rejected { background: #fab1a0; color: #6b1a0a; }
        .status.executed { background: #74b9ff; color: #0a3d6b; }

        .actions { display: flex; gap: 4px; flex-wrap: wrap; }
        .actions form { display: inline; }

        .summary { background: #fff; padding: 16px; border-radius: 6px; margin-bottom: 20px; display: flex; gap: 24px; flex-wrap: wrap; }
        .summary .stat { text-align: center; }
        .summary .stat .num { font-size: 1.5em; font-weight: bold; color: #2c3e50; }
        .summary .stat .label { font-size: 0.8em; color: #888; }
        .hint { color: #666; font-size: 0.85em; margin-top: 6px; }
        .label-good { color: #1a7f37; font-weight: bold; }
        .label-bad { color: #b42318; font-weight: bold; }

        .toolbar { margin-bottom: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .filter-bar { background: #fff; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; display: flex; gap: 8px; align-items: end; flex-wrap: wrap; }
        .filter-bar .field { display: flex; flex-direction: column; gap: 4px; }
        .filter-bar label { font-size: 0.85em; color: #666; }
        .nav-links { display: flex; gap: 12px; margin-bottom: 16px; }
        .nav-links a { color: #3498db; text-decoration: none; font-size: 0.9em; }
        .nav-links a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>メモリー廃棄管理システム</h1>

    <div class="nav-links">
        <a href="{{ url_for('index') }}">ダッシュボード</a>
        <a href="{{ url_for('audit_log') }}">監査ログ</a>
        <a href="{{ url_for('export_csv') }}">CSVエクスポート</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
    <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
    {% endwith %}

    {# --- サマリー (全件ベース) --- #}
    {% set total_cost = all_items | selectattr('cost') | map(attribute='cost') | sum %}
    {% set total_benefit = all_items | selectattr('expected_benefit') | map(attribute='expected_benefit') | sum %}
    {% set total_net = all_items | selectattr('net_effect') | map(attribute='net_effect') | sum %}
    {% set total_quantity = all_items | map(attribute='quantity') | sum %}
    <div class="summary">
        <div class="stat">
            <div class="num">{{ all_items | length }}</div>
            <div class="label">総アイテム数</div>
        </div>
        <div class="stat">
            <div class="num">{{ "{:,}".format(total_quantity) }}</div>
            <div class="label">総数量</div>
        </div>
        <div class="stat">
            <div class="num">&yen;{{ "{:,}".format(total_cost) }}</div>
            <div class="label">総廃棄コスト</div>
        </div>
        <div class="stat">
            <div class="num">&yen;{{ "{:,}".format(total_benefit) }}</div>
            <div class="label">総期待効果</div>
        </div>
        <div class="stat">
            <div class="num {% if total_net >= 0 %}label-good{% else %}label-bad{% endif %}">&yen;{{ "{:,}".format(total_net) }}</div>
            <div class="label">純効果(期待効果-コスト)</div>
        </div>
        <div class="stat">
            <div class="num">{{ all_items | selectattr('status', 'equalto', 'pending') | list | length }}</div>
            <div class="label">未承認</div>
        </div>
        <div class="stat">
            <div class="num">{{ all_items | selectattr('status', 'equalto', 'approved') | list | length }}</div>
            <div class="label">承認済み</div>
        </div>
        <div class="stat">
            <div class="num">{{ all_items | selectattr('risk_score', 'equalto', 3) | list | length }}</div>
            <div class="label">高リスク案件</div>
        </div>
        <div class="stat">
            <div class="num">{{ all_items | selectattr('status', 'equalto', 'executed') | list | length }}</div>
            <div class="label">廃棄済み</div>
        </div>
    </div>

    {# --- アイテム追加フォーム --- #}
    <h2>廃棄対象アイテムを追加</h2>
    <form class="add-form" method="POST" action="{{ url_for('add_item') }}">
        <div class="field">
            <label for="name">アイテム名</label>
            <input type="text" id="name" name="name" required placeholder="例: DDR4 8GB" maxlength="200">
        </div>
        <div class="field">
            <label for="quantity">数量</label>
            <input type="number" id="quantity" name="quantity" value="1" min="1" max="1000000" style="width:100px;">
        </div>
        <div class="field">
            <label for="facility_age">設備年数</label>
            <input type="number" id="facility_age" name="facility_age" value="0" min="0" max="100" style="width:100px;">
        </div>
        <button type="submit">追加</button>
    </form>
    <p class="hint">設備年数20年以上は「生産削減」を推奨、数量が大きい案件は「リサイクル/援助転用」を優先します。</p>

    {# --- 検索・フィルター --- #}
    <h2>廃棄対象在庫リスト</h2>
    <form class="filter-bar" method="GET" action="{{ url_for('index') }}">
        <div class="field">
            <label for="q">検索</label>
            <input type="text" id="q" name="q" value="{{ search_query }}" placeholder="アイテム名で検索">
        </div>
        <div class="field">
            <label for="status">ステータス</label>
            <select id="status" name="status">
                <option value="">すべて</option>
                <option value="pending" {{ 'selected' if status_filter == 'pending' }}>未承認</option>
                <option value="approved" {{ 'selected' if status_filter == 'approved' }}>承認済</option>
                <option value="rejected" {{ 'selected' if status_filter == 'rejected' }}>却下</option>
                <option value="executed" {{ 'selected' if status_filter == 'executed' }}>廃棄済</option>
            </select>
        </div>
        <div class="field">
            <label for="method">廃棄方法</label>
            <select id="method" name="method">
                <option value="">すべて</option>
                {% for key, m in methods.items() %}
                <option value="{{ key }}" {{ 'selected' if method_filter == key }}>{{ m.label }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit">絞り込み</button>
        {% if search_query or status_filter or method_filter %}
        <a href="{{ url_for('index') }}" style="color: #e74c3c; font-size: 0.85em; text-decoration: none;">クリア</a>
        {% endif %}
    </form>

    <div class="toolbar">
        <form method="POST" action="{{ url_for('auto_plan') }}">
            <button type="submit" class="secondary">未設定アイテムへ推奨方法を一括適用</button>
        </form>
        {% if search_query or status_filter or method_filter %}
        <span style="color: #888; font-size: 0.85em;">{{ items | length }}件表示中 / 全{{ all_items | length }}件</span>
        {% endif %}
    </div>

    {% if items %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>アイテム名</th>
                <th>数量</th>
                <th>設備年数</th>
                <th>推奨</th>
                <th>廃棄方法</th>
                <th>コスト</th>
                <th>環境影響</th>
                <th>リスク</th>
                <th>期待効果</th>
                <th>純効果</th>
                <th>ステータス</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.id }}</td>
                <td>{{ item.name }}</td>
                <td>{{ "{:,}".format(item.quantity) }}</td>
                <td>{{ item.facility_age }}年</td>
                <td>{{ methods[recommendations[item.id]].label }}</td>
                <td>
                    {% if item.disposal_method %}
                        {{ methods[item.disposal_method].label }}
                    {% else %}
                        <form method="POST" action="{{ url_for('select_method', item_id=item.id) }}" style="display:flex;gap:4px;flex-wrap:wrap;">
                            <select name="method">
                                {% for key, m in methods.items() %}
                                <option value="{{ key }}">{{ m.label }} (&yen;{{ m.cost_per_unit }}/個)</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="mitigation_note" placeholder="リスク対策メモ(任意)" maxlength="500" style="min-width:160px;">
                            <button type="submit" style="font-size:0.8em;">選択</button>
                        </form>
                    {% endif %}
                </td>
                <td>{% if item.cost %}&yen;{{ "{:,}".format(item.cost) }}{% else %}-{% endif %}</td>
                <td>
                    {% if item.disposal_method %}
                        <span>{{ env_labels[item.env_score] }}</span>
                    {% else %}-{% endif %}
                </td>
                <td>{% if item.disposal_method %}{{ risk_labels[item.risk_score] }}{% else %}-{% endif %}</td>
                <td>{% if item.expected_benefit %}&yen;{{ "{:,}".format(item.expected_benefit) }}{% else %}-{% endif %}</td>
                <td class="{% if item.net_effect >= 0 %}label-good{% else %}label-bad{% endif %}">
                    {% if item.disposal_method %}&yen;{{ "{:,}".format(item.net_effect) }}{% else %}-{% endif %}
                </td>
                <td><span class="status {{ item.status }}">
                    {% if item.status == 'pending' %}未承認
                    {% elif item.status == 'approved' %}承認済
                    {% elif item.status == 'rejected' %}却下
                    {% elif item.status == 'executed' %}廃棄済
                    {% endif %}
                </span></td>
                <td>
                    <div class="actions">
                        {% if item.disposal_method and item.status == 'pending' %}
                        <form method="POST" action="{{ url_for('approve', item_id=item.id) }}">
                            <button type="submit" class="approve" style="font-size:0.8em;">承認</button>
                        </form>
                        <form method="POST" action="{{ url_for('reject', item_id=item.id) }}">
                            <button type="submit" class="warn" style="font-size:0.8em;">却下</button>
                        </form>
                        {% endif %}
                        {% if not item.disposal_method %}
                        <form method="POST" action="{{ url_for('apply_recommendation', item_id=item.id) }}">
                            <button type="submit" class="secondary" style="font-size:0.8em;">推奨適用</button>
                        </form>
                        {% endif %}
                        {% if item.status == 'approved' %}
                        <form method="POST" action="{{ url_for('execute_disposal', item_id=item.id) }}">
                            <button type="submit" style="font-size:0.8em;">廃棄実行</button>
                        </form>
                        {% endif %}
                        {% if item.status == 'rejected' %}
                        <form method="POST" action="{{ url_for('reset_item', item_id=item.id) }}">
                            <button type="submit" class="secondary" style="font-size:0.8em;">リセット</button>
                        </form>
                        {% endif %}
                        <form method="POST" action="{{ url_for('delete_item', item_id=item.id) }}" onsubmit="return confirm('「{{ item.name }}」を削除しますか？この操作は取り消せません。');">
                            <button type="submit" class="danger" style="font-size:0.8em;">削除</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color:#888; margin-top:8px;">
        {% if search_query or status_filter or method_filter %}
            条件に一致するアイテムはありません。<a href="{{ url_for('index') }}">フィルターをクリア</a>
        {% else %}
            廃棄対象のアイテムはありません。
        {% endif %}
    </p>
    {% endif %}
</body>
</html>
